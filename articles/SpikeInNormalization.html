<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spike-in Normalization • BRGenomics</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Spike-in Normalization">
<meta property="og:description" content="BRGenomics">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BRGenomics</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.11.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/Overview.html">Overview</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Guides
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/GettingStarted.html">Getting Started</a>
    </li>
    <li>
      <a href="../articles/ImportingModifyingAnnotations.html">Importing &amp; Modifying Annotations</a>
    </li>
    <li>
      <a href="../articles/ImportingProcessingData.html">Importing &amp; Processing Data</a>
    </li>
    <li>
      <a href="../articles/SignalCounting.html">Signal Counting</a>
    </li>
    <li>
      <a href="../articles/AnalyzingMultipleDatasets.html">Analyzing Multiple Datasets</a>
    </li>
    <li>
      <a href="../articles/ProfilePlotsAndBootstrapping.html">Profile Plots &amp; Bootstrapping</a>
    </li>
    <li>
      <a href="../articles/SpikeInNormalization.html">Spike-in Normalization</a>
    </li>
    <li>
      <a href="../articles/DESeq2WithGlobalPerturbations.html">DESeq2 with Global Perturbations</a>
    </li>
    <li>
      <a href="../articles/SequenceExtraction.html">Sequence Extraction</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Documentation</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mdeber/BRGenomics" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Spike-in Normalization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mdeber/BRGenomics/blob/HEAD/vignettes/SpikeInNormalization.Rmd" class="external-link"><code>vignettes/SpikeInNormalization.Rmd</code></a></small>
      <div class="hidden name"><code>SpikeInNormalization.Rmd</code></div>

    </div>

    
    
<p>BRGenomics includes useful utilities for spike-in normalization.</p>
<p>A typical approach is to add the spike-in (either exogenous cells or synthetic oligonucleotides) before library preparation, and to subsequently map to a <strong>combined genome</strong> containing both the target organisms chromosomes (to map the experimental reads) as well as sequences/chromosomes for the spike-in.</p>
<p>This so-called “competitive alignment” results in the creation of BAM files containing a mix of chromosomes, for which it should be straightforward to identify the spike-in chromosomes.</p>
<div class="section level2">
<h2 id="counting-spike-in-reads">Counting Spike-in Reads<a class="anchor" aria-label="anchor" href="#counting-spike-in-reads"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mdeber.github.io" class="external-link">BRGenomics</a></span><span class="op">)</span></span></code></pre></div>
<p>For this section, we’ll use a list of 4 dummy datasets containing normal, as well as spike-in chromosomes. Consider the first 2 datasets:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grl</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## $gr1_rep1</span></span>
<span><span class="co">## GRanges object with 4 ranges and 1 metadata column:</span></span>
<span><span class="co">##        seqnames    ranges strand |     score</span></span>
<span><span class="co">##           &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]      chr1         1      + |         1</span></span>
<span><span class="co">##   [2]      chr2         2      + |         1</span></span>
<span><span class="co">##   [3] spikechr1         3      + |         1</span></span>
<span><span class="co">##   [4] spikechr2         4      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 4 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep1</span></span>
<span><span class="co">## GRanges object with 4 ranges and 1 metadata column:</span></span>
<span><span class="co">##        seqnames    ranges strand |     score</span></span>
<span><span class="co">##           &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]      chr1         1      + |         2</span></span>
<span><span class="co">##   [2]      chr2         2      + |         2</span></span>
<span><span class="co">##   [3] spikechr1         3      + |         1</span></span>
<span><span class="co">##   [4] spikechr2         4      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 4 sequences from an unspecified genome; no seqlengths</span></span></code></pre>
<p>We can identify the spike-in chromosomes either by full names, or by a regular expression that matches the spike-in chromosomes. In this case, we named our spike-in chromosomes to contain the string “spike” which makes them easy to identify.</p>
<p>To count the reads for each dataset:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getSpikeInCounts.html">getSpikeInCounts</a></span><span class="op">(</span><span class="va">grl</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     sample total_reads exp_reads spike_reads</span></span>
<span><span class="co">## 1 gr1_rep1           4         2           2</span></span>
<span><span class="co">## 2 gr2_rep1           6         4           2</span></span>
<span><span class="co">## 3 gr1_rep2           5         2           3</span></span>
<span><span class="co">## 4 gr2_rep2          12         8           4</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="filtering-spike-in-reads">Filtering Spike-in Reads<a class="anchor" aria-label="anchor" href="#filtering-spike-in-reads"></a>
</h2>
<p>We can also remove the spike-in reads from our data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getSpikeInCounts.html">removeSpikeInReads</a></span><span class="op">(</span><span class="va">grl</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $gr1_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         1</span></span>
<span><span class="co">##   [2]     chr2         2      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         2</span></span>
<span><span class="co">##   [2]     chr2         2      + |         2</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span></code></pre>
<p>And if we wanted to isolate the spike-in reads, there is an analogous <code><a href="../reference/getSpikeInCounts.html">getSpikeInReads()</a></code> function.</p>
</div>
<div class="section level2">
<h2 id="the-spike-in-normalization-factor">The Spike-in Normalization Factor<a class="anchor" aria-label="anchor" href="#the-spike-in-normalization-factor"></a>
</h2>
<p>There are several methods by which to generate spike-in normalization factors, but we advocate for a particular method, which generates units we call <b>S</b>pike-in normalized <b>R</b>eads <b>P</b>er <b>M</b>illion mapped reads in the negative <b>C</b>ontrol (<b>SRPMC</b>). The SRPMC normalization factor for a given sample <span class="math inline">\(i\)</span> is defined as such:</p>
<p><span class="math display">\[SRPMC:\ NF_i = \frac{\sum reads_{spikein, control}}{\sum reads_{spikein, i}} 
\cdot \frac{10^6}{\sum reads_{experimental, control}}\]</span></p>
<p>This expression effectively calculates Reads Per Million (RPM) normalization for the negative control, and all other samples <span class="math inline">\(i\)</span> are scaled into equivalent units according to the ratio of their spike-in reads. We provide a more explicit derivation below.</p>
<div class="section level3">
<h3 id="derivation-of-srpmc">Derivation of SRPMC<a class="anchor" aria-label="anchor" href="#derivation-of-srpmc"></a>
</h3>
<p>The fundamental concept of spike-in normalization is that the ratio of experimental reads to spike-in reads can be used to correct for global changes in starting material. Let’s call this ratio <u>R</u>eads <u>P</u>er <u>S</u>pike-in read (<b>RPS</b>):</p>
<p><span class="math display">\[RPS = \frac{\sum reads_{experimental}}{\sum reads_{spikein}}\]</span></p>
<p>In isolation, this number only reflects the relative amounts of spike-in material recovered and mapped. The meaningful information about changes in material can only arise from making direct comparisons between samples. For any sample, <span class="math inline">\(i\)</span>, we can calculate the global change in signal as a proportion of the material recovered from a negative control:</p>
<p><span class="math display">\[RelativeSignal_i = \frac{RPS_i}{RPS_{control}}\]</span></p>
<p>The usual purpose of spike-in normalization is to measure a biological difference in total material (e.g. RNA) between samples, and the above ratio is a direct measurement of this.</p>
<p>To generate normalization factors, we use the above ratio to adjust RPM (Reads Per Million mapped reads) normalization factors, which we define below for clarity:</p>
<p><span class="math display">\[RPM:\ NF_i = \frac{1}{\frac{\sum{reads_i}}{10^6}} = \frac{10^6}{\sum{reads_i}}\]</span></p>
<p>(Unless indicated, <span class="math inline">\(reads\)</span> refers to non-spike-in reads).</p>
<p>RPM normalization (i.e. read depth normalization) is the simplest and likely most familiar form of normalization. For a basal (unperturbed) negative control, RPM should produce the most portable metric of signal, given that we intend for the negative control to demonstrate typical physiology, and we hope that this state is reproducible. We therefore want to have our normalized signal in unit terms of RPM in the negative control.</p>
<p>To accomplish this, we multiply the ratio of spike-in normalized reads between the sample <span class="math inline">\(i\)</span> and the negative control to the RPM normalization factor for sample <span class="math inline">\(i\)</span>. This converts readcounts into units we summarize as <u>S</u>pike-in normalized <u>R</u>eads <u>P</u>er <u>M</u>illion mapped reads in the negative <u>C</u>ontrol (SRPMC):</p>
<p><span class="math display">\[SRPMC:\ NF_i = \frac{RPS_i}{RPS_{control}} \cdot \frac{10^6}{\sum{reads_i}}\]</span></p>
<p>Again, SRPMC results in the negative control being RPM (sequencing depth) normalized, while all other samples are in equivalent, directly comparable units. And we’ve effectively determined the relative scaling of those samples based on the ratios of spike-in reads.</p>
<p>This becomes more apparent if we substitute the <span class="math inline">\(RPS\)</span> variables above. <span class="math inline">\(\sum{reads_i}\)</span> cancels, and simplifying the fraction produces the original formula:</p>
<p><span class="math display">\[SRPMC:\ NF_i = \frac{\sum reads_{spikein, control}}{\sum reads_{spikein, i}} 
\cdot \frac{10^6}{\sum reads_{experimental, control}}\]</span></p>
</div>
</div>
<div class="section level2">
<h2 id="calculating-normalization-factors">Calculating Normalization Factors<a class="anchor" aria-label="anchor" href="#calculating-normalization-factors"></a>
</h2>
<p>We can calculate SRPMC normalization factors for each sample using the <code><a href="../reference/getSpikeInNFs.html">getSpikeInNFs()</a></code> function, using the same syntax we used to count the spike-in reads.</p>
<p>However, we have to also identify the negative control, which is the sample that will have the “reference” (RPM) normalization. We do this either using a regular expression (<code>ctrl_pattern</code> argument) or by supplying the name(s) of the negative controls (the <code>ctrl_names</code> argument).</p>
<p>The default method is “SRPMC”, but there are other options, as well.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getSpikeInNFs.html">getSpikeInNFs</a></span><span class="op">(</span><span class="va">grl</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, ctrl_pattern <span class="op">=</span> <span class="st">"gr1"</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 500000 500000 500000 375000</span></span></code></pre>
<p>(The NFs are high because our dummy data contain only a few reads).</p>
<p>By default, normalization factors utilize <strong>batch normalization</strong>, such that in any replicate (identified by the characters following “rep” in the sample names), the negative control is RPM normalized, and the other conditions are normalized to the within-replicate negative control (see the documentation for further details).</p>
<p>Currently, batch normalization requires the sample names end with strings matching the format <code>"_rep1"</code>, <code>"_rep2"</code>, etc. If sample names do not conform to this pattern, you can rename them by using the <code>sample_names</code> argument.</p>
</div>
<div class="section level2">
<h2 id="normalizing-data">Normalizing Data<a class="anchor" aria-label="anchor" href="#normalizing-data"></a>
</h2>
<p>We can also use the <code><a href="../reference/getSpikeInNFs.html">spikeInNormGRanges()</a></code> function to simultaneously find the spike-in reads, calculate the spike-in normalization factors, filter out spike-in reads, and normalize the readcounts:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getSpikeInNFs.html">spikeInNormGRanges</a></span><span class="op">(</span><span class="va">grl</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, ctrl_pattern <span class="op">=</span> <span class="st">"gr1"</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $gr1_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |     5e+05</span></span>
<span><span class="co">##   [2]     chr2         2      + |     5e+05</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |     1e+06</span></span>
<span><span class="co">##   [2]     chr2         2      + |     1e+06</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr1_rep2</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |     5e+05</span></span>
<span><span class="co">##   [2]     chr2         2      + |     5e+05</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep2</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |   1500000</span></span>
<span><span class="co">##   [2]     chr2         2      + |   1500000</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="normalization-by-sub-sampling">Normalization by Sub-sampling<a class="anchor" aria-label="anchor" href="#normalization-by-sub-sampling"></a>
</h2>
<div class="section level3">
<h3 id="rationale">Rationale<a class="anchor" aria-label="anchor" href="#rationale"></a>
</h3>
<p>When viewing genomics data in a genome browser (or otherwise plotting signal for a single gene), the sparsity of basepair resolution data can challenge our visual perception.</p>
<p>Consider two datasets from identical samples, but where one is sequenced to a higher depth. The two datasets can be normalized such that the signal counts are equivalent, but the dataset with higher sequencing depth will have also uncovered additional sites. When plotted in a genome browser, the total signal within a region may be the same, but the more highly sequenced dataset will cover more positions but have lower peaks, while the less sequenced dataset will look sparse and spikey in comparison.</p>
<p>Below, we compare PRO-seq data derived from the same dataset over the same gene. In one case, we randomly sample half of the reads over that gene, while in another, we divide all the readcounts by 2.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"PROseq"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"txs_dm6_chr4"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># choose a single gene</span></span>
<span><span class="va">gene_i</span> <span class="op">&lt;-</span> <span class="va">txs_dm6_chr4</span><span class="op">[</span><span class="fl">185</span><span class="op">]</span></span>
<span><span class="va">reads.gene_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/IRanges/man/findOverlaps-methods.html" class="external-link">subsetByOverlaps</a></span><span class="op">(</span><span class="va">PROseq</span>, <span class="va">gene_i</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># sample half the raw reads</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">sreads.gene_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subsampleGRanges.html">subsampleGRanges</a></span><span class="op">(</span><span class="va">reads.gene_i</span>, prop <span class="op">=</span> <span class="fl">0.5</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># downscale raw reads by a factor of 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/score.html" class="external-link">score</a></span><span class="op">(</span><span class="va">reads.gene_i</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/score.html" class="external-link">score</a></span><span class="op">(</span><span class="va">reads.gene_i</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/score.html" class="external-link">score</a></span><span class="op">(</span><span class="va">reads.gene_i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 738.5</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/score.html" class="external-link">score</a></span><span class="op">(</span><span class="va">sreads.gene_i</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] 738</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html" class="external-link">width</a></span><span class="op">(</span><span class="va">gene_i</span><span class="op">)</span>, </span>
<span>     y <span class="op">=</span> <span class="fu"><a href="../reference/getCountsByPositions.html">getCountsByPositions</a></span><span class="op">(</span><span class="va">sreads.gene_i</span>, <span class="va">gene_i</span><span class="op">)</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"h"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"PRO-seq (down-sampled)"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"Distance from TSS"</span>, ylab <span class="op">=</span> <span class="st">"Down-sampled PRO-seq Reads"</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpikeInNormalization_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/start.html" class="external-link">width</a></span><span class="op">(</span><span class="va">gene_i</span><span class="op">)</span>, </span>
<span>     y <span class="op">=</span> <span class="fu"><a href="../reference/getCountsByPositions.html">getCountsByPositions</a></span><span class="op">(</span><span class="va">reads.gene_i</span>, <span class="va">gene_i</span><span class="op">)</span>,</span>
<span>     type <span class="op">=</span> <span class="st">"h"</span>,  ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>     main <span class="op">=</span> <span class="st">"PRO-seq (down-scaled)"</span>, </span>
<span>     xlab <span class="op">=</span> <span class="st">"Distance from TSS"</span>,  ylab <span class="op">=</span> <span class="st">"Down-scaled PRO-seq Reads"</span><span class="op">)</span></span></code></pre></div>
<p><img src="SpikeInNormalization_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<p>The two plots above come from the same data, and contain the same quantity of signal, but their profiles are notably distinct. Particularly when plotting many samples over large regions within a genome browser, differences caused by sequencing depth can be misleading. It can be challenging to estimate differences if some datasets are “tall and spikey” while others are “short and smooth”.</p>
<p>Absent global changes in signal, the above scenario can be resolved beforehand by equal sequencing depths, or by down-sampling to match readcounts.</p>
<p>However, matching raw readcounts is not a solution when significant biological changes in total signal should be accounted for.</p>
<p>For instance, consider an example in which there is a true, two-fold biological difference in transcription between two samples. If we could avoid all technical artifacts and measure the transcription directly in each individual cell, we would expect to uncover half the number of transcribing complexes in the lower condition. Having equivalent sequencing depth across those two conditions is effectively a technical artifact, and down-scaling the signal by multiplication can cause the visual challenges observed above.</p>
</div>
<div class="section level3">
<h3 id="sub-sampling-for-normalization">Sub-sampling for Normalization<a class="anchor" aria-label="anchor" href="#sub-sampling-for-normalization"></a>
</h3>
<p>To address the above concerns, we’ve included a function <code><a href="../reference/subsampleBySpikeIn.html">subsampleBySpikeIn()</a></code> to randomly sample reads to match the normalized signal proportions between datasets.</p>
<p>Internally, the function uses the <code><a href="../reference/getSpikeInNFs.html">getSpikeInNFs()</a></code> function, but instead of SRPMC normalization, using the option <code>method = "SNR"</code>, which calculates normalization factors that downscale each dataset to match the dataset with the least spike-in reads. From this, the number of “desired reads” is established for each dataset, and subsequently that number of reads is randomly sampled.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getSpikeInCounts.html">removeSpikeInReads</a></span><span class="op">(</span><span class="va">grl</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $gr1_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         1</span></span>
<span><span class="co">##   [2]     chr2         2      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         2</span></span>
<span><span class="co">##   [2]     chr2         2      + |         2</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr1_rep2</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         1</span></span>
<span><span class="co">##   [2]     chr2         2      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep2</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;numeric&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         4</span></span>
<span><span class="co">##   [2]     chr2         2      + |         4</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span></code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getSpikeInNFs.html">getSpikeInNFs</a></span><span class="op">(</span><span class="va">grl</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, method <span class="op">=</span> <span class="st">"SNR"</span>, batch_norm <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>              ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.0000000 1.0000000 0.6666667 0.5000000</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/subsampleBySpikeIn.html">subsampleBySpikeIn</a></span><span class="op">(</span><span class="va">grl</span>, si_pattern <span class="op">=</span> <span class="st">"spike"</span>, batch_norm <span class="op">=</span> <span class="cn">FALSE</span>, ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $gr1_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         1</span></span>
<span><span class="co">##   [2]     chr2         2      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep1</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         2</span></span>
<span><span class="co">##   [2]     chr2         2      + |         2</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr1_rep2</span></span>
<span><span class="co">## GRanges object with 1 range and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         1</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $gr2_rep2</span></span>
<span><span class="co">## GRanges object with 2 ranges and 1 metadata column:</span></span>
<span><span class="co">##       seqnames    ranges strand |     score</span></span>
<span><span class="co">##          &lt;Rle&gt; &lt;IRanges&gt;  &lt;Rle&gt; | &lt;integer&gt;</span></span>
<span><span class="co">##   [1]     chr1         1      + |         1</span></span>
<span><span class="co">##   [2]     chr2         2      + |         3</span></span>
<span><span class="co">##   -------</span></span>
<span><span class="co">##   seqinfo: 2 sequences from an unspecified genome; no seqlengths</span></span></code></pre>
<p>Normalization by sub-sampling sacrifices information to reduce biases across datasets.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Mike DeBerardine.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
